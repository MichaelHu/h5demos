function get_line_with_2points(t,e){var a={};return t.x-e.x==0?null:(a.k=(e.y-t.y)/(e.x-t.x),a.b=t.y-a.k*t.x,a)}function get_line_with_point_and_gradient(t,e){var a={};a.k=e,a.b=t.y-a.k*t.x}function get_distance_between_2points(t,e){return Math.sqrt(Math.pow(e.y-t.y,2)+Math.pow(e.x-t.x,2))}function get_intersect_between_line_and_circle(t,e){var a,n,i,r,s=[],o=t.k,l=t.b,d=e.a,h=e.c,c=e.r,f=1+o*o,u=2*(l*o-h*o-d),p=d*d+l*l+h*h-2*l*h-c*c,g=u*u-4*f*p,w=Math.sqrt;if(Math.pow,g>0)a=(-u-w(g))/(2*f),n=o*a+l,i=(-u+w(g))/(2*f),r=o*i+l,s.push({x:a,y:n}),s.push({x:i,y:r});
else{if(0!=g)return null;a=-u/(2*f),n=o*a+l,s.push({x:a,y:n})}return s}function get_data_range(t){for(var e,a,n={},i=0;i<t.length;i++)0==i?e=a=t[i]:(t[i]<e&&(e=t[i]),t[i]>a&&(a=t[i]));if(!t.length)throw new Error("get_data_range: data can not be empty");return n.min=e,n.span=a-e,0==n.span&&(n.min-=50,n.max+=50,n.span=100),n}var Canvas=function(t){var e=function(e){if("string"==typeof e&&(e=t(e)),e=t(e)[0],!e||!e.tagName||"canvas"!=e.tagName.toLowerCase())throw new Error("there not a canvas element");
this.canvas=e,this.ctx=this.canvas.getContext("2d")};return e.prototype={getContext:function(){return this.ctx},getTextWidth:function(t){return this.ctx.measureText(t).width},getWidth:function(){return this.canvas.width},getHeight:function(){return this.canvas.height},strokeStyle:function(t){return t&&(this.ctx.strokeStyle=t),this},fillStyle:function(t){return t&&(this.ctx.fillStyle=t),this},lineCap:function(t){return t&&(this.ctx.lineCap=t),this},lineJoin:function(t){return t&&(this.ctx.lineJoin=t),this
},lineWidth:function(t){return"number"==typeof t&&(this.ctx.lineWidth=t),this},rect:function(t,e,a,n){return this.ctx.rect(t,e,a,n),this},fillRect:function(t,e,a,n){return this.ctx.fillRect(t,e,a,n),this},strokeRect:function(t,e,a,n){return this.ctx.strokeRect(t,e,a,n),this},clearRect:function(t,e,a,n){return this.ctx.clearRect(t,e,a,n),this},fill:function(){return this.ctx.fill(),this},stroke:function(){return this.ctx.stroke(),this},beginPath:function(){return this.ctx.beginPath(),this},closePath:function(){return this.ctx.closePath(),this
},moveTo:function(t,e){return this.ctx.moveTo(t,e),this},lineTo:function(t,e){return this.ctx.lineTo(t,e),this},clip:function(){return this.ctx.clip(),this},arc:function(t,e,a,n,i,r){return this.ctx.arc(t,e,a,n,i,r),this},quadraticCurveTo:function(t,e,a,n){return this.ctx.quadraticCurveTo(t,e,a,n),this},bezierCurveTo:function(t,e,a,n,i,r){return this.ctx.bezierCurveTo(t,e,a,n,i,r),this},arcTo:function(t,e,a,n,i){return this.ctx.arcTo(t,e,a,n,i),this},isPointInPath:function(t,e){return this.ctx.isPointInPath(t,e),this
},scale:function(t,e){return this.ctx.scale(t,e),this},rotate:function(t){return this.ctx.rotate(t),this},translate:function(t,e){return this.ctx.translate(t,e),this},transform:function(t,e,a,n,i,r){return this.ctx.transform(t,e,a,n,i,r),this},setTransform:function(t,e,a,n,i,r){return this.ctx.setTransform(t,e,a,n,i,r),this},font:function(t){return this.ctx.font=t,this},textAlign:function(t){return this.ctx.textAlign=t,this},textBaseline:function(t){return this.ctx.textBaseline=t,this},fillText:function(t,e,a,n){return this.ctx.fillText(t,e,a,n||this.getTextWidth(t)),this
},strokeText:function(t,e,a,n){return this.ctx.strokeText(t,e,a,n),this},globalAlpha:function(t){return this.ctx.globalAlpha=t,this},globalCompositeOperation:function(t){return this.ctx.globalCompositeOperation=t,this},save:function(){return this.ctx.save(),this},restore:function(){return this.ctx.restore(),this},width:function(t){return t&&(this.canvas.width=t),this},height:function(t){return t&&(this.canvas.height=t),this},css:function(){return t.fn.css.apply(t(this.canvas),arguments),this}},e}(Zepto);
!function(t){t.extend(Canvas.prototype,{on:function(e,a){return t(this.canvas).on(e,a),this},off:function(e,a){return t(this.canvas).off(e,a),this}})}(Zepto);var LineChart=function(t){function e(t){this.init(t)}var a=e.fn=e.prototype;return t.extend(a,{init:function(e){var a,n=this;if(n.opt={enableGrids:!0,enableAxis:!0,enableBackground:!0,enableLines:!0,enableIntersect:!0,enableLabels:!0,enableLastGrid:!0,enableCurrentValue:!0,enableLastValue:!0,enableFPS:!0,enableShowTail:!1,enableDrag:!0,enableTouchTrace:!0,dragAccelerate:3,canvasWidth:640,canvasHeight:480,step:100,marginTop:20,marginRight:20,marginBottom:20,marginLeft:20,paddingTop:20,paddingRight:20,paddingBottom:20,paddingLeft:20,rangeExpand:.2,backgroundOpacity:.5,backgroundColor:"#7ea4b8",axisOpacity:1,axisLineWidth:2,axisStrokeStyle:"#7591ac",gridOpacity:.4,gridLineWidth:2,gridStrokeStyle:"#f8f8f8",lastGridOpacity:1,lastGridLineWidth:2,lastGridStrokeStyle:"#b2c4d5",lastGridFootSize:10,intersectRadius:8,intersectOpacity:1,intersectLineWidth:2,intersectStrokeStyle:"#ffffff",currentPointOpacity:.5,currentPointtLineWidth:6,currentPointStrokeStyle:"#ffffff",currentPointRadius:10,currentLabelOffsetY:-10,linesOpacity:1,linesLineWidth:2,linesStrokeStyle:"#ffffff",labelFont:"normal normal 28px Serif",labelOpacity:.4,labelLastLableOpacity:1,labelTextAlign:"center",labelTextBaseline:"top",labelFillStyle:"#fffff",labelPaddingTop:8,currentValueFont:"normal normal 28px Arial",currentValueTextAlign:"center",currentValueFillStyle:"#ffffff",currentValueOffsetY:-20,currentValueThreshold:48,lastValueFont:"normal normal 28px Arial",lastValueTextAlign:"center",lastValueBackgroundColor:"#ffffff",lastValueFillStyle:"rgba(0,0,0,0.4)",lastValueOffsetY:-30,lastValueThreshold:58,lastValuePaddingHorizontal:6,lastValuePaddingVertical:6,lastValueHeight:40,data:[],labels:[],canvas:null,initOffsetX:0,noDrawHiddenArea:!0},a=n.opt,t.extend(a,e),!a.data||!a.data.length)throw new Error("opt.data should be supplied");
if(a.canvas){if(!a.canvas instanceof Canvas)throw new Error("opt.canvas should be an instance of Canvas")}else a.canvas=new Canvas(t("<canvas/>").appendTo("body"));a.drawArea={x:a.marginLeft,y:a.marginTop,w:a.canvasWidth-a.marginLeft-a.marginRight,h:a.canvasHeight-a.marginTop-a.marginBottom},a.enableShowTail?(a._offsetX=a.drawArea.w-a.step*a.data.length,a._currentPoint=1+Math.abs(parseInt((a._offsetX-a.initOffsetX)/a.step))):(a._offsetX=a.initOffsetX,a._currentPoint=0),a._currentPointThreshold=parseInt(a.step/2),a.range=get_data_range(a.data),n.fixRange(),a.ratio=a.range.span/(a.drawArea.h-a.paddingTop-a.paddingBottom),n.initCanvas()
},fixRange:function(){var t=this,e=t.opt,a=e.range.span;e.range.span+=a*e.rangeExpand,e.range.min-=a*e.rangeExpand/2}}),e}(Zepto);LineChart.fn.initCanvas=function(){var t=this,e=t.opt;e.canvas.width(e.canvasWidth).height(e.canvasHeight).css({width:e.canvasWidth/2+"px",height:e.canvasHeight/2+"px"})},LineChart.fn.initCoordinates=function(){for(var t=this,e=t.opt,a=e.X=[],n=e.Y=[],i=0,r=0;r<e.data.length;i+=e.step,r++)a.push(e.drawArea.x+e.paddingLeft+i),n.push(e.drawArea.y+e.drawArea.h-e.paddingBottom-(e.data[r]-e.range.min)/e.ratio);
for(var i=0;i<a.length;i++)a[i]+=e._offsetX;return t},LineChart.fn.draw=function(){var t=this,e=t.opt;return t.isFakeDraw||$.os.ios?(t.checkTime(),t.isRedraw&&e.canvas.clearRect(0,0,e.canvasWidth,e.canvasHeight),t.initCoordinates().drawBackground().drawAxis().drawGrids().drawLastGrid().drawLines().drawIntersections().drawLabels().drawCurrentValue().drawLastValue().showFPS().setupDrag(),void 0):(t.isFakeDraw=!0,t.fakeDraw(),setTimeout(function(){t.draw()},10),void 0)},LineChart.fn.fakeDraw=function(){var t=this,e=t.opt;
e.canvas.clearRect(0,0,e.canvasWidth,e.canvasHeight)},LineChart.fn.redraw=function(t){var e=this,a=e.opt;$.extend(a,t),e.isFakeDraw=!1,e.draw()},LineChart.fn.drawAxis=function(){var t=this,e=t.opt,a=e.canvas;return e.X,e.Y,e.enableAxis?(a.save().globalAlpha(e.axisOpacity).lineWidth(e.axisLineWidth).strokeStyle(e.axisStrokeStyle).beginPath().moveTo(e.drawArea.x+e.paddingLeft+.5,e.drawArea.y+e.paddingTop+.5).lineTo(e.drawArea.x+e.paddingLeft+.5,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).lineTo(e.drawArea.x+e.drawArea.w-e.paddingRight-.5,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).stroke().restore(),this):this
},LineChart.fn.drawBackground=function(){var t=this,e=t.opt;return e.enableBackground?(e.canvas.save().globalAlpha(e.backgroundOpacity).fillStyle(e.backgroundColor).fillRect(e.drawArea.x,e.drawArea.y,e.drawArea.w,e.drawArea.h).restore(),this):this},LineChart.fn.drawCurrentValue=function(){var t,e,a=this,n=a.opt,i=n.canvas,r=n.X,s=n.Y,o=n._currentPoint,l="bottom",d=n.currentValueOffsetY;return n.enableCurrentValue&&o!=n.data.length-1?(t=r[o],e=s[o],e-n.drawArea.y-n.paddingTop<n.currentValueThreshold&&(l="top",d*=-1),i.save().beginPath().rect(n.drawArea.x+n.paddingLeft,n.drawArea.y+n.paddingTop,n.drawArea.w-n.paddingLeft-n.paddingRight,n.drawArea.h-n.paddingTop-n.paddingBottom).clip().font(n.currentValueFont).textAlign(n.currentValueTextAlign).textBaseline(l).fillStyle(n.currentValueFillStyle).fillText(parseInt(n.data[o]),t,e+d).restore(),a):a
},LineChart.fn.drawGrids=function(){var t=this,e=t.opt,a=e.canvas,n=e.X,i=e.Y;if(!e.enableGrids)return this;a.save().beginPath().rect(e.drawArea.x+e.paddingLeft,e.drawArea.y+e.paddingTop,e.drawArea.w-e.paddingLeft-e.paddingRight,e.drawArea.h-e.paddingTop-e.paddingBottom).clip().globalAlpha(e.gridOpacity).lineWidth(e.gridLineWidth).strokeStyle(e.gridStrokeStyle);for(var r=0;r<n.length;r++)e.noDrawHiddenArea&&(n[r]<0&&n[r]+e.step<0||n[r]>e.canvasWidth&&n[r]-e.canvasWidth>e.step)||a.beginPath().moveTo(n[r]+.5,i[r]+e.intersectRadius+.5).lineTo(n[r]+.5,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).stroke();
return a.restore(),this},LineChart.fn.drawIntersections=function(){var t=this,e=t.opt,a=e.canvas,n=e.X,i=e.Y;if(!e.enableIntersect)return this;a.save().beginPath().rect(e.drawArea.x+e.paddingLeft,e.drawArea.y+e.paddingTop,e.drawArea.w-e.paddingLeft-e.paddingRight,e.drawArea.h-e.paddingTop-e.paddingBottom).clip().globalAlpha(e.intersectOpacity).lineWidth(e.intersectLineWidth).strokeStyle(e.intersectStrokeStyle).fillStyle(e.intersectStrokeStyle);for(var r=0;r<n.length;r++)e.noDrawHiddenArea&&(n[r]<0&&n[r]+e.step<0||n[r]>e.canvasWidth&&n[r]-e.canvasWidth>e.step)||(a.beginPath().moveTo(n[r]+e.intersectRadius,i[r]).arc(n[r],i[r],e.intersectRadius,0,2*Math.PI,!1).closePath().stroke(),r==n.length-1&&a.fill());
return r=e._currentPoint,a.globalAlpha(e.currentPointOpacity).lineWidth(e.currentPointtLineWidth).strokeStyle(e.currentPointStrokeStyle).beginPath().moveTo(n[r]+e.currentPointRadius,i[r]).arc(n[r],i[r],e.currentPointRadius,0,2*Math.PI,!1).closePath().stroke(),a.restore(),this},LineChart.fn.drawLabels=function(){var t,e,a=this,n=a.opt,i=n.canvas,r=n.labels,s=n.drawArea.y+n.drawArea.h-n.paddingBottom;if(!n.enableLabels)return this;t=n.step*(n.data.length-1)/(r.length-1),i.save().beginPath().rect(n.drawArea.x+n.paddingLeft,n.drawArea.y+n.drawArea.h-n.paddingBottom,n.drawArea.w-n.paddingLeft-n.paddingRight,n.paddingBottom).clip().globalAlpha(n.labelOpacity).font(n.labelFont).textAlign(n.labelTextAlign).textBaseline(n.labelTextBaseline).fillStyle(n.labelFillStyle);
for(var o=0,e=n.drawArea.x+n.paddingLeft+n._offsetX;o<r.length-1;o++,e+=t)n.noDrawHiddenArea&&(0>e&&0>e+t||e>n.canvasWidth&&e-n.canvasWidth>t)||i.fillText(r[o],e,s+n.labelPaddingTop);return n.noDrawHiddenArea&&(0>e&&0>e+t||e>n.canvasWidth&&e-n.canvasWidth>t)||i.globalAlpha(n.labelLastLabelOpacity).fillText(r[o],e,s+n.labelPaddingTop),i.restore(),this},LineChart.fn.drawLastGrid=function(){var t=this,e=t.opt,a=e.canvas,n=e.X,i=e.Y,r=n.length-1;return!e.enableLastGrid||0>r?t:e.noDrawHiddenArea&&(n[r]<0&&n[r]+e.step<0||n[r]>e.canvasWidth&&n[r]-e.canvasWidth>e.step)?t:(a.save().beginPath().rect(e.drawArea.x+e.paddingLeft,e.drawArea.y+e.paddingTop,e.drawArea.w-e.paddingLeft-e.paddingRight,e.drawArea.h-e.paddingTop-e.paddingBottom+e.lastGridLineWidth).clip().globalAlpha(e.lastGridOpacity).lineWidth(e.lastGridLineWidth).strokeStyle(e.lastGridStrokeStyle).beginPath().moveTo(n[r]+.5,i[r]+e.intersectRadius+.5).lineTo(n[r]+.5,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).moveTo(n[r]+.5-e.lastGridFootSize,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).lineTo(n[r]+.5+e.lastGridFootSize,e.drawArea.y+e.drawArea.h-e.paddingBottom+.5).stroke().restore(),this)
},LineChart.fn.drawLastValue=function(){var t,e,a,n,i,r,s=this,o=s.opt,l=o.canvas,d=o.X,h=o.Y,c=o.data.length-1,f="top",u=o.lastValueOffsetY,p=o.lastValueHeight,g=parseInt(o.data[c]);return o.enableLastValue?(t=d[c],e=h[c],a=u-p,n=a+p,i=a+p+7,e-o.drawArea.y-o.paddingTop<o.lastValueThreshold&&(a=-u,n=a,i=a-7),l.save().beginPath().rect(o.drawArea.x+o.paddingLeft,o.drawArea.y+o.paddingTop,o.drawArea.w-o.paddingLeft-o.paddingRight,o.drawArea.h-o.paddingTop-o.paddingBottom).clip().font(o.lastValueFont).textAlign(o.lastValueTextAlign).textBaseline(f).fillStyle(o.lastValueBackgroundColor).strokeStyle(o.lastValueBackgroundColor),r=l.getTextWidth(g),l.beginPath().rect(t-r/2-o.lastValuePaddingHorizontal,e+a,r+2*o.lastValuePaddingHorizontal,p).fill().beginPath().moveTo(t-5,e+n).lineTo(t,e+i).lineTo(t+5,e+n).closePath().fill().fillStyle(o.lastValueFillStyle).fillText(g,t,e+a+o.lastValuePaddingVertical).restore(),s):s
},LineChart.fn.drawLines=function(){var t=this,e=t.opt,a=e.canvas,n=e.X,i=e.Y;if(!e.enableLines)return this;a.save().beginPath().rect(e.drawArea.x+e.paddingLeft,e.drawArea.y+e.paddingTop,e.drawArea.w-e.paddingLeft-e.paddingRight,e.drawArea.h-e.paddingTop-e.paddingBottom).clip().globalAlpha(e.linesOpacity).lineWidth(e.linesLineWidth).strokeStyle(e.linesStrokeStyle);for(var r,s,o,l,d={x:0,y:0},h={x:0,y:0},c=1;c<n.length;c++)e.noDrawHiddenArea&&(n[c-1]<0&&n[c-1]+e.step<0||n[c]>e.canvasWidth&&n[c]-e.canvasWidth>e.step)||(r={a:n[c-1],c:i[c-1],r:e.intersectRadius},s={a:n[c],c:i[c],r:e.intersectRadius},o=get_line_with_2points({x:n[c-1],y:i[c-1]},{x:n[c],y:i[c]}),l=get_intersect_between_line_and_circle(o,r),l&&(d=2==l.length?l[1]:l[0]),l=get_intersect_between_line_and_circle(o,s),l&&(h=l[0]),a.beginPath().moveTo(d.x,d.y).lineTo(h.x,h.y).stroke());
return a.restore(),t},LineChart.fn.checkTime=function(){var t=this;return t.timeRenderStart=(new Date).getTime(),t},LineChart.fn.showFPS=function(){var t,e=this,a=e.opt,n=(new Date).getTime(),i=1/(n+1-e.timeRenderStart)*1e3;return a.enableFPS?(t=e.fpsArr=e.fpsArr||[],t.push(i),e.$info=e.$info||$('<div class="__line-chart-fps"></div>').appendTo("body").css({position:"absolute",display:"none",top:"5px",right:"10px",padding:"0 5px","background-color":"rgba(0,0,0,0.3)",height:"28px",color:"#fff",font:"normal normal 14px/28px Arial"}),setTimeout(function(){for(var a=0,n=0,i=0;i<t.length;i++)a+=t[i];
t.length&&(n=a/t.length),e.$info.show().html("fps: "+parseInt(n))},1e3),e):e},LineChart.fn.setupDrag=function(){var t,e,a=this,n=a.opt,i=n.canvas;return!n.enableDrag||a.isRedraw||n.data.length<=1?void 0:(a.isRedraw=!0,i.on("touchstart",function(e){t=e.targetTouches[0].clientX}).on("touchmove",function(i){var r,s,o,l=i.targetTouches[0],d=0;i.preventDefault(),n.enableTouchTrace&&(r=l.clientX-t,t=l.clientX,a.isBusy||(a.isBusy=!0,setTimeout(function(){a.isBusy=!1},40),s=n._offsetX+n.dragAccelerate*r,o=n.step*(n.data.length-1),e=n._offsetX,n._offsetX=s<n.initOffsetX&&s+o<=n.step+n.initOffsetX?-o+n.step+n.initOffsetX:s>=n.initOffsetX?n.initOffsetX:s,Math.abs((n._offsetX-n.initOffsetX)%n.step)<n._currentPointThreshold&&(d=Math.abs(parseInt((n._offsetX-n.initOffsetX)/n.step)),n._currentPoint=0>r?d+1:d,n._currentPoint==n.data.length-1&&n._currentPoint>=0&&n._currentPoint--),e!=n._offsetX&&a.draw()))
}).on("touchend",function(e){var i,r=e.changedTouches[0];n.enableTouchTrace||(i=r.clientX-t,n._offsetX+=i,a.draw())}),this)};